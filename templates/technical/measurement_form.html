{% extends 'base.html' %}

{% block title %}–°–Ω—è—Ç–∏–µ –∑–∞–º–µ—Ä–æ–≤ - {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="bi bi-rulers me-2"></i>
                    –°–Ω—è—Ç–∏–µ –∑–∞–º–µ—Ä–æ–≤ - #{{ order.order_number }}
                </h2>
                <a href="{% url 'technical:my_tasks' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    –ó–∞–¥–∞—á–∏
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>–ö–ª–∏–µ–Ω—Ç:</strong><br>
                        {{ order.customer.get_full_name }}<br>
                        <small class="text-muted">{{ order.customer.phone }}</small>
                        {% for phone in order.customer.additional_phones.all %}
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">{{ phone.phone_number }}</small>
                                {% if phone.notes %}
                                <small class="text-muted">({{ phone.notes }})</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mb-3">
                        <strong>–ê–¥—Ä–µ—Å:</strong><br>
                        <small>{{ order.address }}</small>
                    </div>
                    <div class="mb-3">
                        <strong>–°–æ–∑–¥–∞–Ω:</strong><br>
                        <small>{{ order.created_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    <div class="mb-0">
                        <span class="badge bg-info">{{ order.get_status_display }}</span>
                        <!-- DEBUG: –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é -->
                        {% if existing_items_count > 0 %}
                        <br><small class="text-muted mt-2 d-block">üìã {{ existing_items_count }} –∂–∞–ª—é–∑–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 p-0 m-0">
            <!-- –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
            <div class="mb-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>
                            –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">–í—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏</label>
                            <input type="date" class="form-control" id="installation_scheduled_date" 
                                    required value="{{ existing_installation_date }}">
                        </div>

                        <div class="d-flex justify-content-between align-items-center gap-3">
                            <input type="hidden" id="latitude" name="latitude" 
                                class="form-control" step="any" 
                                placeholder="41.311081" readonly 
                                value="{{ existing_gps_lat|default:'' }}">
                            
                            <input type="hidden" id="longitude" name="longitude" 
                                class="form-control" step="any" 
                                placeholder="69.240562" readonly
                                value="{{ existing_gps_lng|default:'' }}">
                            
                            <input type="hidden" id="location_accuracy" name="location_accuracy" 
                                class="form-control" readonly
                                value="{{ existing_gps_accuracy|default:'' }}">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" id="getLocationBtn" class="btn btn-primary">
                                <i class="bi bi-geo-alt-fill me-1"></i>
                                {% if has_existing_gps %}–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ{% else %}–ü–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ{% endif %}
                            </button>
                            
                            <button type="button" id="openMapBtn" class="btn btn-outline-primary" 
                                    {% if not has_existing_gps %}style="display: none;"{% endif %}>
                                <i class="bi bi-map me-1"></i>
                                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                            </button>
                        </div>
                        
                        <div id="locationStatus" class="mt-2">
                            {% if has_existing_gps %}
                            <div class="alert alert-success small">
                                <i class="bi bi-check-circle me-1"></i>
                                GPS —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {{ existing_gps_lat|floatformat:6 }}, {{ existing_gps_lng|floatformat:6 }}
                                {% if existing_gps_accuracy %}
                                <br><small>–¢–æ—á–Ω–æ—Å—Ç—å: {{ existing_gps_accuracy }}–º</small>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –∑–∞–º–µ—Ä—É -->
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-chat-text me-2"></i>
                        –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –∑–∞–º–µ—Ä—É
                    </h6>
                </div>
                <div class="card-body">
                    <textarea name="measurement_notes" class="form-control mb-3" rows="3" 
                                placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–º–µ—Ä–∞...">{{ existing_measurement_notes }}</textarea>
                </div>
            </div>
                        <!-- –ê–≤–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ -->
            <div class="mt-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-cash-stack me-2"></i>
                            –ê–≤–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">–°—É–º–º–∞</label>
                                <input type="number" name="advance_payment" class="form-control" 
                                        min="0" step="1000" placeholder="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                                <select name="payment_method" class="form-select">
                                    <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                                    <option value="card">–ö–∞—Ä—Ç–∞</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –∑–∞–º–µ—Ä–∞ -->
    <div>
        <form method="post" class="needs-validation" novalidate id="measurement-form">
            {% csrf_token %}
            
            <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è GPS –¥–∞–Ω–Ω—ã—Ö -->
            <input type="hidden" name="measurement_latitude" id="measurement_latitude">
            <input type="hidden" name="measurement_longitude" id="measurement_longitude">
            <input type="hidden" name="measurement_location_accuracy" id="measurement_location_accuracy">
            <input type="hidden" name="installation_scheduled_date" id="measurement_installation_scheduled_date">

            
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-plus-circle me-2"></i>
                        –°–ø–∏—Å–æ–∫ –∂–∞–ª—é–∑–∏
                        {% if existing_items_count > 0 %}
                        <span class="badge bg-info ms-2">{{ existing_items_count }} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
                        {% else %}
                        <span class="badge bg-secondary ms-2">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>
                        {% endif %}
                    </h6>
                </div>
                <div class="card-body">
                    <div id="items-container">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center gap-3">
                        <button type="button" id="add-item" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-plus me-1"></i>
                            –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∂–∞–ª—é–∑–∏
                        </button>
                        <div class="d-flex flex-row align-items-center gap-2">
                            <input type="checkbox" class="m-0" id="advance_payment_checkbox" name="advance_payment_checkbox">
                            <label class="form-label m-0" for="advance_payment_checkbox" style="cursor: pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</label>
                        </div>
                    </div>
                    
                    <input type="hidden" id="item-count" name="item_count" value="0">
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center gap-3">
                        <a href="{% url 'technical:my_tasks' %}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-arrow-left me-1"></i>
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∑–∞–¥–∞—á
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle me-1"></i>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å 
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


<!-- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ JSON –¥–∞–Ω–Ω—ã—Ö -->
{{ existing_items|json_script:"existing-items-data" }}
{{ existing_gps_lat|json_script:"existing-gps-lat" }}
{{ existing_gps_lng|json_script:"existing-gps-lng" }}
{{ existing_gps_accuracy|json_script:"existing-gps-accuracy" }}
{{ existing_items_count|json_script:"existing-items-count" }}

<script>
// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ JSON –¥–∞–Ω–Ω—ã—Ö
const existingItemsData = JSON.parse(document.getElementById('existing-items-data').textContent || '[]');
const existingGpsLat = JSON.parse(document.getElementById('existing-gps-lat').textContent || 'null');
const existingGpsLng = JSON.parse(document.getElementById('existing-gps-lng').textContent || 'null');
const existingGpsAccuracy = JSON.parse(document.getElementById('existing-gps-accuracy').textContent || '""');
const existingItemsCount = JSON.parse(document.getElementById('existing-items-count').textContent || '0');

// –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å –±—ç–∫–µ–Ω–¥–∞
const EXISTING_DATA = {
    items: existingItemsData,
    gps: { lat: existingGpsLat, lng: existingGpsLng, accuracy: existingGpsAccuracy },
    debug: { itemsCount: existingItemsCount, orderStatus: "{{ order.status|escapejs }}", orderId: {{ order.id|default:0 }} }
};

console.log('üîß DEBUG: –î–∞–Ω–Ω—ã–µ, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞ –≤ JavaScript:', EXISTING_DATA);
</script>


<!-- ================================================================== -->
<!-- JAVASCRIPT - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ò –û–ß–ò–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø -->
<!-- ================================================================== -->
<script>
let itemCount = 0;

// ----- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ -----
const blindTypeDisplayNames = { 'horizontal': '–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –∂–∞–ª—é–∑–∏', 'vertical': '–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –∂–∞–ª—é–∑–∏', 'roller': '–†–æ–ª–∏–∫–æ–≤—ã–µ —à—Ç–æ—Ä—ã', 'pleated': '–ü–ª–∏—Å—Å–µ', 'bamboo': '–ë–∞–º–±—É–∫–æ–≤—ã–µ –∂–∞–ª—é–∑–∏', 'wooden': '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–µ –∂–∞–ª—é–∑–∏', 'fabric': '–¢–∫–∞–Ω–µ–≤—ã–µ –∂–∞–ª—é–∑–∏' };
const materialDisplayNames = { 'aluminum': '–ê–ª—é–º–∏–Ω–∏–π', 'plastic': '–ü–ª–∞—Å—Ç–∏–∫', 'wood': '–î–µ—Ä–µ–≤–æ', 'fabric': '–¢–∫–∞–Ω—å', 'bamboo': '–ë–∞–º–±—É–∫', 'composite': '–ö–æ–º–ø–æ–∑–∏—Ç' };
const installationTypes = { 'wall': '–ù–∞—Å—Ç–µ–Ω–Ω–∞—è', 'ceiling': '–ü–æ—Ç–æ–ª–æ—á–Ω–∞—è', 'window_frame': '–ù–∞ —Ä–∞–º—É –æ–∫–Ω–∞', 'niche': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è' };
const mechanismTypes = { 'cord': '–í–µ—Ä–µ–≤–æ—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', 'chain': '–¶–µ–ø–æ—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', 'wand': '–¢—Ä–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è', 'motorized': '–≠–ª–µ–∫—Ç—Ä–æ–º–æ—Ç–æ—Ä', 'remote': '–ü—É–ª—å—Ç –î–£', 'smart': '–£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ' };

// ----- –§–£–ù–ö–¶–ò–ò –§–û–†–ú–´ –≠–õ–ï–ú–ï–ù–¢–û–í -----
function createItemForm(index, existingData = null) {
    return `
        <div class="item-form border rounded p-3 mb-3" data-index="${index}" ${existingData ? 'style="border-left: 4px solid #28a745 !important;"' : ''}>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">
                    –ñ–∞–ª—é–∑–∏ #${index + 1}
                    ${existingData ? '<span class="badge bg-success ms-2">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>' : '<span class="badge bg-secondary ms-2">–ù–æ–≤–æ–µ</span>'}
                </h6>
                <button type="button" class="btn btn-danger btn-sm remove-item" data-remove-index="${index}">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="row">
                <div class="col-sm-4 mb-3"><label class="form-label">–ö–æ–º–Ω–∞—Ç–∞ *</label><input type="text" name="area_${index}" class="form-control" required value="${existingData?.room_name || ''}"></div>
                <div class="col-sm-4 mb-3"><label class="form-label">–¢–∏–ø –∂–∞–ª—é–∑–∏ *</label><select name="blind_type_${index}" class="form-select" required>${Object.entries(blindTypeDisplayNames).map(([v,d]) => `<option value="${v}" ${existingData?.blind_type_raw === v ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                <div class="col-sm-4 mb-3"><label class="form-label">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label><select name="material_type_${index}" class="form-select">${Object.entries(materialDisplayNames).map(([v,d]) => `<option value="${v}" ${existingData?.material_raw === v ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                <div class="col-sm-2 mb-3"><label class="form-label">–®–∏—Ä–∏–Ω–∞ (—Å–º) *</label><input type="number" name="width_${index}" data-calc="width" class="form-control" min="10" required value="${existingData?.width || ''}"></div>
                <div class="col-sm-2 mb-3"><label class="form-label">–í—ã—Å–æ—Ç–∞ (—Å–º) *</label><input type="number" name="height_${index}" data-calc="height" class="form-control" min="10" required value="${existingData?.height || ''}"></div>
                <div class="col-sm-2 mb-3"><label class="form-label">–º¬≤</label><input type="number" name="kv_${index}" class="form-control" disabled step="0.01"></div>
                <div class="col-sm-2 mb-3"><label class="form-label">–¶–µ–Ω–∞ –∑–∞ –µ–¥. *</label><input type="number" name="unit_price_${index}" data-calc="unit_price" class="form-control" min="0" step="1000" required value="${existingData?.unit_price || ''}"></div>
                <div class="col-sm-2 mb-3"><label class="form-label">–¶–µ–Ω–∞ –∑–∞ –º¬≤</label><input type="number" name="kv_price_${index}" data-calc="kv_price" class="form-control" step="1000"></div>
                <div class="col-sm-2 mb-3"><label class="form-label">–ö–æ–ª-–≤–æ</label><input type="number" name="quantity_${index}" class="form-control" min="1" value="${existingData?.quantity || 1}"></div>
                <div class="col-sm-6 mb-3"><label class="form-label">–¢–∏–ø —É—Å—Ç–∞–Ω–æ–≤–∫–∏</label><select name="installation_type_${index}" class="form-select">${Object.entries(installationTypes).map(([v,d]) => `<option value="${v}" ${existingData?.installation_type_raw === v ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                <div class="col-sm-6 mb-3"><label class="form-label">–¢–∏–ø –º–µ—Ö–∞–Ω–∏–∑–º–∞</label><select name="mechanism_type_${index}" class="form-select">${Object.entries(mechanismTypes).map(([v,d]) => `<option value="${v}" ${existingData?.mechanism_raw === v ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                <div class="col-12 mb-3"><label class="form-label">–î–æ–ø. –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ</label><textarea name="notes_${index}" class="form-control" rows="2">${existingData?.notes || ''}</textarea></div>
                <div class="col-12"><input type="checkbox" name="is_measured_${index}" id="is_measured_${index}" class="form-check-input" ${existingData?.is_measured ? 'checked' : ''}> <label class="form-label" for="is_measured_${index}">–ó–∞–º–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω</label></div>
            </div>
        </div>
    `;
}

function updatePriceCalculations(index, source) {
    const itemForm = document.querySelector(`.item-form[data-index="${index}"]`);
    if (!itemForm) return;

    const widthInput = itemForm.querySelector('[data-calc="width"]');
    const heightInput = itemForm.querySelector('[data-calc="height"]');
    const unitPriceInput = itemForm.querySelector('[data-calc="unit_price"]');
    const kvPriceInput = itemForm.querySelector('[data-calc="kv_price"]');
    const kvInput = itemForm.querySelector('[name^="kv_"]');

    const width = parseFloat(widthInput.value) || 0;
    const height = parseFloat(heightInput.value) || 0;
    const unitPrice = parseFloat(unitPriceInput.value) || 0;
    const kvPrice = parseFloat(kvPriceInput.value) || 0;

    const area = (width > 0 && height > 0) ? (width * height / 10000) : 0;
    kvInput.value = area.toFixed(2);

    if (source === 'kv_price') {
        if (area > 0) {
            unitPriceInput.value = Math.round(kvPrice * area);
        }
    } else {
        if (area > 0) {
            kvPriceInput.value = Math.round(unitPrice / area);
        } else {
            kvPriceInput.value = '';
        }
    }
}

function addItem(existingData = null) {
    const container = document.getElementById('items-container');
    container.insertAdjacentHTML('beforeend', createItemForm(itemCount, existingData));
    
    if (existingData) {
        setTimeout(() => {
            updatePriceCalculations(itemCount, 'unit_price');
            itemCount++;
            updateItemCount();
        }, 100);
    } else {
        itemCount++;
        updateItemCount();
    }
}

function removeItem(index) {
    document.querySelector(`[data-index="${index}"]`)?.remove();
    updateItemNumbers();
}

function updateItemCount() {
    document.getElementById('item-count').value = document.querySelectorAll('.item-form').length;
}

function updateItemNumbers() {
    document.querySelectorAll('.item-form').forEach((item, index) => {
        item.dataset.index = index;
        const h6 = item.querySelector('h6');
        const badge = h6.querySelector('.badge');
        h6.innerHTML = `–ñ–∞–ª—é–∑–∏ #${index + 1} ${badge.outerHTML}`;
        item.querySelector('.remove-item').dataset.removeIndex = index;
        
        item.querySelectorAll('input, select, textarea').forEach(input => {
            if (input.name) input.name = input.name.replace(/_\d+$/, `_${index}`);
            if (input.id) input.id = input.id.replace(/_\d+$/, `_${index}`);
            const label = item.querySelector(`label[for="${input.id}"]`);
            if (label) label.htmlFor = input.id;
        });
    });
    updateItemCount();
}

// ----- –§–£–ù–ö–¶–ò–ò –ö–ê–†–¢–´ –ò GPS -----
function addMapStyles() {
    if (document.getElementById('custom-map-styles')) return;
    const style = document.createElement('style');
    style.id = 'custom-map-styles';
    style.textContent = `
        .map-loading { display: flex; align-items: center; justify-content: center; height: 100%; text-align: center; flex-direction: column; background: #f8f9fa; }
        .map-loading .spinner-border { width: 3rem; height: 3rem; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.2); border-radius: 8px; }
        .leaflet-container a.leaflet-popup-close-button { color: #555; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
    `;
    document.head.appendChild(style);
}

function showSimpleMap(lat, lng, mapDiv) {
    mapDiv.innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-center bg-light">
            <h5><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>–ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å</h5>
            <p class="text-muted">–í–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã.</p>
            <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
            <div>
                <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn btn-sm btn-primary">Google Maps</a>
                <a href="https://yandex.uz/maps/?ll=${lng},${lat}&z=18" target="_blank" class="btn btn-sm btn-secondary">–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</a>
            </div>
        </div>`;
}

function createInteractiveMap(lat, lng, mapDiv) {
    mapDiv.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const map = L.map(mapDiv).setView([lat, lng], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const marker = L.marker([lat, lng]).addTo(map);
    const accuracy = parseFloat(document.getElementById('location_accuracy')?.value) || 10;
    L.circle([lat, lng], { radius: accuracy, weight: 1 }).addTo(map);
    
    marker.bindPopup(`<b>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}`).openPopup();
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    setTimeout(() => map.invalidateSize(), 100);
}

function loadLeafletAndInitializeMap(lat, lng, mapDiv) {
    mapDiv.innerHTML = `<div class="map-loading"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p></div>`;
    addMapStyles();

    if (document.querySelector('script[src*="leaflet"]')) {
        setTimeout(() => createInteractiveMap(lat, lng, mapDiv), 500);
        return;
    }

    const leafletCSS = document.createElement('link');
    leafletCSS.rel = 'stylesheet';
    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(leafletCSS);

    const leafletJS = document.createElement('script');
    leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    leafletJS.onload = () => createInteractiveMap(lat, lng, mapDiv);
    leafletJS.onerror = () => showSimpleMap(lat, lng, mapDiv);
    document.head.appendChild(leafletJS);
}

function initializeMap(lat, lng) {
    const mapDiv = document.getElementById('map');
    if (!mapDiv) return;

    if (typeof L === 'undefined') {
        loadLeafletAndInitializeMap(lat, lng, mapDiv);
    } else {
        createInteractiveMap(lat, lng, mapDiv);
    }
}

function initializeGPS() {
    const getLocationBtn = document.getElementById('getLocationBtn');
    const openMapBtn = document.getElementById('openMapBtn');
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    const accuracyInput = document.getElementById('location_accuracy');
    const statusDiv = document.getElementById('locationStatus');

    if (!getLocationBtn) return;
    
    const setHiddenGpsValues = (lat, lng, acc) => {
        document.getElementById('measurement_latitude').value = lat;
        document.getElementById('measurement_longitude').value = lng;
        document.getElementById('measurement_location_accuracy').value = acc;
    };

    if (EXISTING_DATA.gps.lat && EXISTING_DATA.gps.lng) {
        setHiddenGpsValues(EXISTING_DATA.gps.lat, EXISTING_DATA.gps.lng, EXISTING_DATA.gps.accuracy);
    }

    getLocationBtn.addEventListener('click', () => {
        const originalText = getLocationBtn.innerHTML;
        getLocationBtn.disabled = true;
        getLocationBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin me-1"></i>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...';
        statusDiv.innerHTML = '<div class="alert alert-info small"><i class="bi bi-hourglass-split me-1"></i>–û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞ GPS...</div>';

        if (!navigator.geolocation) {
            statusDiv.innerHTML = '<div class="alert alert-danger small">–§—É–Ω–∫—Ü–∏—è GPS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</div>';
            getLocationBtn.disabled = false;
            getLocationBtn.innerHTML = originalText;
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude, accuracy } = position.coords;
                latInput.value = latitude.toFixed(6);
                lngInput.value = longitude.toFixed(6);
                accuracyInput.value = Math.round(accuracy);
                setHiddenGpsValues(latitude.toFixed(6), longitude.toFixed(6), Math.round(accuracy));

                statusDiv.innerHTML = `<div class="alert alert-success small"><i class="bi bi-check-circle me-1"></i>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ! <br><small>–¢–æ—á–Ω–æ—Å—Ç—å: ${Math.round(accuracy)}–º</small></div>`;
                openMapBtn.style.display = 'block';
                getLocationBtn.disabled = false;
                getLocationBtn.innerHTML = '<i class="bi bi-geo-alt-fill me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
            },
            (error) => {
                let msg = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
                if (error.code === 1) msg = '–î–æ—Å—Ç—É–ø –∫ GPS –∑–∞–ø—Ä–µ—â–µ–Ω.';
                if (error.code === 2) msg = '–°–∏–≥–Ω–∞–ª GPS –Ω–µ –Ω–∞–π–¥–µ–Ω.';
                if (error.code === 3) msg = '–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ.';
                statusDiv.innerHTML = `<div class="alert alert-danger small"><i class="bi bi-exclamation-triangle me-1"></i>${msg}</div>`;
                getLocationBtn.disabled = false;
                getLocationBtn.innerHTML = originalText;
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
    });

    openMapBtn.addEventListener('click', () => {
        const lat = latInput.value;
        const lng = lngInput.value;
        if (!lat || !lng) { alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ!'); return; }

        let modalEl = document.getElementById('mapModal');
        if (modalEl) modalEl.remove();

        const modalHtml = `
            <div class="modal fade" id="mapModal" tabindex="-1">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content">
                        <div class="modal-header"><h5 class="modal-title">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body p-0"><div id="map" style="height: 100%; width: 100%;"></div></div>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        modalEl = document.getElementById('mapModal');
        const mapModal = new bootstrap.Modal(modalEl);

        modalEl.addEventListener('shown.bs.modal', () => initializeMap(parseFloat(lat), parseFloat(lng)));
        mapModal.show();
    });
}

function loadExistingData() {
    const container = document.getElementById('items-container');
    if (!container) return;
    container.innerHTML = '';
    itemCount = 0;

    if (EXISTING_DATA?.items?.length > 0) {
        EXISTING_DATA.items.forEach(item => addItem(item));
    } else {
        addItem();
    }
}

// ----- DOMContentLoaded (–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø) -----
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è...');
    
    initializeGPS();
    loadExistingData();

    document.getElementById('add-item')?.addEventListener('click', () => addItem());

    const itemsContainer = document.getElementById('items-container');
    itemsContainer.addEventListener('input', (e) => {
        const calcSource = e.target.dataset.calc;
        if (calcSource) {
            const itemForm = e.target.closest('.item-form');
            if (itemForm) {
                updatePriceCalculations(parseInt(itemForm.dataset.index, 10), calcSource);
            }
        }
    });

    itemsContainer.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-item');
        if (removeBtn) {
            removeItem(parseInt(removeBtn.dataset.removeIndex, 10));
        }
    });

    document.getElementById('measurement-form')?.addEventListener('submit', function(e) {
        document.getElementById('measurement_installation_scheduled_date').value = document.getElementById('installation_scheduled_date')?.value || '';

        if (!this.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        this.classList.add('was-validated');
    });
    
    console.log('üéâ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã.');
});
</script>

<style>
.item-form {
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    border: 2px solid #dee2e6 !important;
}
.item-form:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.item-form[style*="border-left: 4px solid #28a745"] {
    background-color: #f0fff2;
}
.item-form[style*="border-left: 4px solid #28a745"]:hover {
    background-color: #e6ffe8;
}
.form-label {
    font-weight: 600;
    color: #495057;
}
.remove-item {
    opacity: 0.7;
    transition: opacity 0.2s;
}
.remove-item:hover {
    opacity: 1;
}
.badge {
    font-size: 0.75em;
}
.alert {
    border-radius: 8px;
    font-size: 0.9rem;
    animation: slideDown 0.5s ease-out;
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}